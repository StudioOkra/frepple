{% extends "admin/base_site_grid.html" %}
{% load i18n %}

{% block extrahead %}
{{ block.super }}
<script>
function executeJob(jobId) {
    fetch(`${url_prefix}/scheduler/execute/${jobId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('成功', '排程作業已開始執行', true);
            window.location.reload();
        } else {
            showMessage('錯誤', '執行失敗：' + data.message, false);
        }
    })
    .catch(error => {
        showMessage('錯誤', '執行時發生錯誤：' + error, false);
    });
}
</script>
{% endblock %}

{% block grid %}
{{ block.super }}
<script>
grid.addFormatter({
    executeButton: function(cellvalue, options, rowdata) {
        if (rowdata.can_start) {
            return `<button class="btn btn-primary btn-sm" onclick="executeJob(${rowdata.id})">執行排程</button>`;
        }
        return `<button class="btn btn-primary btn-sm" disabled>執行排程</button>`;
    }
});

// 在 columns 定義中加入執行按鈕欄位
var extraColumns = [{
    name: 'actions',
    label: '{% trans "操作" %}',
    width: 80,
    align: 'center',
    formatter: 'executeButton',
    sortable: false,
    search: false
}];

grid.extraColumns = extraColumns;
</script>
{% endblock %}
