{% extends "admin/base_site_grid.html" %}
{% load i18n %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link href="{% static 'css/dhtmlxgantt.css' %}" rel="stylesheet">
<script src="{% static 'js/dhtmlxgantt.js' %}"></script>
{% endblock %}

{% block before_table %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div id="scheduler_gantt" style="width:100%; height:500px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
// gantt.config.xml_date = "%Y-%m-%d %H:%i:%s";
// gantt.config.scale_unit = "day";
// gantt.config.date_scale = "%d %M";
// gantt.config.subscales = [
//     {unit: "hour", step: 6, date: "%H:00"}
// ];
gantt.config.scale_height = 50;
gantt.config.scales = [
    {unit: "month", step: 1, format: "%F, %Y"},
    {unit: "day", step: 1, format: "%j, %D"},
    {unit: "hour", step: 1, format: "%H:00"}
];
gantt.config.columns = [
    {name: "text", label: "Operation", tree: true, width: 200},
    {name: "start_date", label: "Start Time", align: "center", width: 100},
    {name: "end_date", label: "End Time", align: "center", width: 100}
];

gantt.init("scheduler_gantt");
gantt.load("{% url 'scheduler:gantt_data_all' %}");

gantt.attachEvent("onAfterTaskUpdate", function(id, task){
    fetch("{% url 'scheduler:update_operation' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            operation_id: id,
            start_date: task.start_date,
            end_date: task.end_date
        })
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            gantt.message({text: "更新成功", type: "success"});
        } else {
            gantt.message({text: data.message, type: "error"});
            gantt.refreshData();
        }
    });
});
</script>
{% endblock %}

{% block content %}
{{ block.super }}
{% endblock %}
